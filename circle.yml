machine:
  ruby:
    version: 2.3.4
  node:
    version: 8.1.2
  pre:
    - mkdir ~/.yarn-cache
  post:
    # Install Cloud Foundry command line client for deployment
    - curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&version=6.17.0&source=github'
    - sudo dpkg -i cf-cli_amd64.deb

dependencies:
  pre:
    - sudo apt-key adv --fetch-keys http://dl.yarnpkg.com/debian/pubkey.gpg
    - echo "deb http://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
    - sudo apt-get update -qq
    - sudo apt-get install -y -qq yarn
    - rm -rf /home/ubuntu/ict-dashboard/node_modules/
    - rm -rf /home/ubuntu/ict-dashboard/frontend/node_modules/
  override:
    - yarn install
    - cd frontend && yarn install
    - yarn build
    - cd backend && bundle install
  cache_directories:
    - ~/.yarn
    - ~/.yarn-cache
  post:
    # - noop

deployment:
  staging:
    branch: staging
    owner: AusDTO
    commands:
      - cf api $CF_API_DEV &> /dev/null
      - cf auth $CF_USER_DEV $CF_PASSWORD_DEV &> /dev/null
      - cf target -o $CF_ORG_DEV &> /dev/null
      - cf target -s $CF_SPACE_STAGING &> /dev/null
      - cd backend && cf push ict-dashboard-staging
      - cd backend && cf push ict-import-staging
